#include <stdio.h>
#include <stdlib.h>
#include <string.h>


struct card {
	char suit;
	int number;
	int null; //1 = null
};

struct player {
	int id;
	struct card* hand;
	char type;
};

void printBoard(int, int, struct card**);
void game(int width, int height, struct card** board, struct player p1, struct player p2, struct card* deck, int* deckLength);


struct card* readDeck(FILE* deckFile, int* numCardPointer) {
	//--------------------------------------
	// Function takes an opened deckFile and pointer to a num card
	// 
	// Returns an array of card *objects* (structs) and changes the
	// dereferenced numCardPointer to the value of the num of cards 
	// in the array
	// -------------------------------------
	
	int next = 0;
	int numCards;
	int position = 0;
	char* charNumCards = malloc(sizeof(char) * 5); //change size later
	
	while (1) {
		next = fgetc(deckFile);
		if (next == '\n') {
			charNumCards[position] = '\0';
			break;
		} else {
			//check if int and if EOF
			charNumCards[position++] = (char) next;
		}
	}
	numCards = atoi(charNumCards);
	struct card* deck = malloc(sizeof(struct card) * (numCards));

	//for array size tracking
	*numCardPointer = numCards;
	if (numCards < 11) {
		printf("not enough cards in deck \n");
		//err
		return deck;
	}
	for (int i = 0; i < numCards; i++) {
		int num;
		char suitChar;
		struct card tempCard;
		
		next = fgetc(deckFile);
		if (((next - '0') <= 9) && ((next - '0') >= 1)) {
			num = next - '0';
		} else { //throw error
			printf("no sir \n");
			break;
		}
		
		next = fgetc(deckFile);
		if ((next - 'A') >= 0 && (next - 'A') <= 25) {
			suitChar = (char) next;
		} else { //throw err
			printf("char error \n");
			break;
		}
		
		next = fgetc(deckFile);
		if (next != '\n') {
			//throw err
		}
		
		tempCard.null = 0;
		tempCard.number = num;
		tempCard.suit = suitChar;
		deck[i] = tempCard;
		
	}
	
	return deck;

}



void newGame(char** argv) {
	//this function focuses on initializing and setting up the game
	struct card blankCard;
	blankCard.null = 1;
	char* deckFileString = argv[1]; 
	int w = atoi(argv[2]);
	int h = atoi(argv[3]);
	//initialize new players
	struct player p1;
	p1.id = 1;
	p1.hand = (struct card*) malloc(sizeof(struct card) * 6); 
	struct player p2;
	p2.id = 2;
	p2.hand = (struct card*) malloc(sizeof(struct card) * 6);
	
	//init deck
	FILE* deckFile = fopen(deckFileString, "r");
	int numDeckCards;
	struct card* deck;
	deck = readDeck(deckFile, &numDeckCards);
	fclose(deckFile);

	//init hand
	for (int i = 0; i < 5; i++) {
		int p2Index = i + 5;
		p1.hand[i] = deck[i];
		p2.hand[i] = deck[p2Index];
		deck[i].null = 1;
		deck[p2Index].null = 1;
	}

	//init board
	struct card** board = (struct card**) malloc(sizeof(struct card*) * w);
	for (int i = 0; i < w; i++) {
		board[i] = (struct card*) malloc(sizeof(struct card) * h);
		//set to default blank cards
		for (int j = 0; j < h; j++) {
			board[i][j] = blankCard; 
		}
	}
	//after all is initialized, start game
	
	game(w, h, board, p1, p2, deck, &numDeckCards); 
}

void place(int x, int y, int cardNum, struct player p) {
	
}

void printBoard(int width, int height, struct card** board) {

	for (int h = 0; h < height; h++) {
		for (int w = 0; w < width; w++) {
			//decode the card for printing
			if (board[w][h].null == 1) {
				printf(" * ");
			}
			else {
				printf("%d%c ", board[w][h].number, board[w][h].suit);
			}
		}
		printf("\n");
	}
}

void printDeck(struct card* deck, int numCards) {
	printf("current deck: ");
	for (int i = 0; i < numCards; i++) {
		if (deck[i].null != 1) {
			printf(" %d%c ",deck[i].number,deck[i].suit);
		}
	}
	printf("\n");

}

void printHand(struct player p) {
	printf("Player(%d) Hand: ",p.id);
	for (int i = 0; i < 5; i++) {
		//todo: check null card`
		printf(" %d%c ", p.hand[i].number, p.hand[i].suit);
	}
	printf("\n");

}

void game(int width, int height, struct card** board, struct player p1, 
		struct player p2, struct card* deck, int* numCards) {
	//temporary tests
	
	printBoard(width, height, board);
	printDeck(deck, *numCards);
	printHand(p1);
}

int main(int argc, char** argv) {
	
	if (argc == 6) {
		newGame(argv);
	}

	if (argc == 4) {
		//code to load game
	}

	else {
		//exit status 1	
	}	

	return 0;
}
